name: Generate Go Protobuf Files

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  generate-go-proto:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install protoc
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Install protoc plugins
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.33.0
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.3.0
        go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@v2.17.0
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Download googleapis (for annotations.proto)
      run: |
        git clone --depth=1 https://github.com/googleapis/googleapis.git /tmp/googleapis
    - name: Fix ownership
      run: sudo chown -R $(id -u):$(id -g) generated/go/

    - name: Generate Go, gRPC, Gateway, Descriptor files
      run: |
        PROTO_ROOT=protobuf
        OUT_ROOT=generated/go
        GOOGLEAPIS_DIR=/tmp/googleapis

        mkdir -p $OUT_ROOT

        for pkg_dir in generated/go/*; do
          # Skip non-directories
          [ -d "$pkg_dir" ] || continue

          pkg=$(basename "$pkg_dir")
          proto_src_dir="protobuf/$pkg"

          # ‚úÖ If proto directory doesn't exist anymore, remove the whole generated dir
          if [ ! -d "$proto_src_dir" ]; then
                    echo "üóë Removing stale package directory: $pkg_dir"
                    sudo rm -rf "$pkg_dir"
                    continue
          fi

          # Clean up stale .pb descriptor files
          descriptor_dir="$pkg_dir/descriptor"
          if [ -d "$descriptor_dir" ]; then
                    for pb_file in "$descriptor_dir"/*.pb; do
                              base=$(basename "$pb_file" .pb)
                              if [ ! -f "$proto_src_dir/$base.proto" ]; then
                                        echo "üóë Removing stale descriptor file: $pb_file"
                                        sudo chmod u+w "$pb_file" || true
                                        sudo rm -f "$pb_file"
                              fi
                    done
          fi
        done
        dirs=$(find $PROTO_ROOT -type d -mindepth 1)
        if [ -z "$dirs" ]; then
          echo "‚ö†Ô∏è No proto subdirectories found in $PROTO_ROOT"
          exit 1
        fi

        for dir in $dirs; do
          pkg=$(basename "$dir")
          out_dir=$OUT_ROOT/$pkg
          descriptor_dir=$out_dir/descriptor

          mkdir -p "$out_dir"
          mkdir -p "$descriptor_dir"

        
          # Find all proto files and generate together
          proto_files=$(find "$dir" -maxdepth 1 -name "*.proto")
          if [ -z "$proto_files" ]; then
                    echo "‚ö†Ô∏è No .proto files found in $dir"
                    continue
          fi

          protoc \
                --proto_path="$PROTO_ROOT" \
                --proto_path="$GOOGLEAPIS_DIR" \
                --go_out="$OUT_ROOT" --go_opt=paths=source_relative \
                --go-grpc_out="$OUT_ROOT" --go-grpc_opt=paths=source_relative \
                --grpc-gateway_out="$OUT_ROOT" --grpc-gateway_opt=paths=source_relative \
                --descriptor_set_out="$descriptor/${pkg}.pb" \
                --include_imports \
                $proto_files
        done
    - name: Update depedency go modules
      run: |
        go mod tidy
    - name: Commit generated files
      run: |
        if find generated/go -type f | grep -q .; then
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add -f generated/go/
          git commit -m "Auto-generate protobuf and descriptor files [CI]" || echo "‚ÑπÔ∏è No changes to commit"
          git push origin main
        else
          echo "‚ö†Ô∏è No generated files found ‚Äî skipping commit."
        fi
        